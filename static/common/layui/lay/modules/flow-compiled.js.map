{"version":3,"sources":["flow.js"],"names":[],"mappings":"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","file":"flow-compiled.js","sourcesContent":["/**\n\n @Name：layui.flow 流加载\n @Author：贤心\n @License：LGPL\n    \n */\n \n \nlayui.define('jquery', function(exports){\n  \"use strict\";\n  \n  var $ = layui.jquery, Flow = function(options){}\n  ,ELEM_MORE = 'layui-flow-more'\n  ,ELEM_LOAD = '<i class=\"layui-anim layui-anim-rotate layui-anim-loop layui-icon \">&#xe63e;</i>';\n\n  //主方法\n  Flow.prototype.load = function(options){\n    var that = this, page = 1, lock, isOver, lazyimg, timer;\n    options = options || {};\n    \n    var elem = $(options.elem); if(!elem[0]) return;\n    var scrollElem = $(options.scrollElem || document); //滚动条所在元素\n    var mb = options.mb || 50; //与底部的临界距离\n    var isAuto = 'isAuto' in options ? options.isAuto : true; //是否自动滚动加载\n    var isShowEnd = 'isShowEnd' in options ? options.isShowEnd : true; //是否显示加载更多\n    \n    //滚动条所在元素是否为document\n    var notDocment = options.scrollElem && options.scrollElem !== document;\n    \n    //加载更多\n    var ELEM_TEXT = '<cite>加载更多</cite>'\n    ,more = $('<div class=\"layui-flow-more\"><a href=\"javascript:;\">'+ ELEM_TEXT +'</a></div>');\n    \n    if(!elem.find('.layui-flow-more')[0]){\n      elem.append(more);\n    }\n    \n    //加载下一个元素\n    var next = function(html, over){ \n      html = $(html);\n      more.before(html);\n      over = over == 0 ? true : null;\n      over ? more.html(isShowEnd ? '没有更多了' : '') : more.find('a').html(ELEM_TEXT);\n      isOver = over;\n      lock = null;\n      lazyimg && lazyimg();\n    };\n    \n    //触发请求\n    var done = function(){\n      lock = true;\n      more.find('a').html(ELEM_LOAD);\n      typeof options.done === 'function' && options.done(++page, next);\n    };\n    \n    //不自动滚动加载\n    more.find('a').on('click', function(){\n      var othis = $(this);\n      if(isOver) return;\n      lock || done();\n    });\n    \n    //如果允许图片懒加载\n    if(options.isLazyimg){\n      var lazyimg = that.lazyimg({\n        elem: options.elem + ' img'\n        ,scrollElem: scrollElem\n      });\n    }\n    \n    if(!isAuto) return that;\n    \n    scrollElem.on('scroll', function(){\n      var othis = $(this), top = othis.scrollTop();\n      \n      if(timer) clearTimeout(timer);\n      if(isOver) return;\n      \n      timer = setTimeout(function(){\n        //计算滚动所在容器的可视高度\n        var height = notDocment ? othis.height() : $(window).height();\n        \n        //计算滚动所在容器的实际高度\n        var scrollHeight = notDocment\n          ? othis.prop('scrollHeight')\n        : document.documentElement.scrollHeight;\n\n        //临界点\n        if(scrollHeight - top - height <= mb){\n          lock || done();\n        }\n      }, 100);\n    });\n    return that;\n  };\n  \n  //图片懒加载\n  Flow.prototype.lazyimg = function(options){\n    var that = this, index = 0, haveScroll;\n    options = options || {};\n    \n    var scrollElem = $(options.scrollElem || document); //滚动条所在元素\n    var elem = options.elem || 'img';\n    \n    //滚动条所在元素是否为document\n    var notDocment = options.scrollElem && options.scrollElem !== document;\n    \n    //显示图片\n    var show = function(item, height){\n      var start = scrollElem.scrollTop(), end = start + height;\n      var elemTop = notDocment ? function(){\n        return item.offset().top - scrollElem.offset().top + start;\n      }() : item.offset().top;\n\n      /* 始终只加载在当前屏范围内的图片 */\n      if(elemTop >= start && elemTop <= end){\n        if(!item.attr('src')){\n          var src = item.attr('lay-src');\n          layui.img(src, function(){\n            var next = that.lazyimg.elem.eq(index);\n            item.attr('src', src).removeAttr('lay-src');\n            \n            /* 当前图片加载就绪后，检测下一个图片是否在当前屏 */\n            next[0] && render(next);\n            index++;\n          });\n        }\n      }\n    }, render = function(othis, scroll){\n      \n      //计算滚动所在容器的可视高度\n      var height = notDocment ? (scroll||scrollElem).height() : $(window).height();\n      var start = scrollElem.scrollTop(), end = start + height;\n\n      that.lazyimg.elem = $(elem);\n\n      if(othis){\n        show(othis, height);\n      } else {\n        //计算未加载过的图片\n        for(var i = 0; i < that.lazyimg.elem.length; i++){\n          var item = that.lazyimg.elem.eq(i), elemTop = notDocment ? function(){\n            return item.offset().top - scrollElem.offset().top + start;\n          }() : item.offset().top;\n          \n          show(item, height);\n          index = i;\n          \n          //如果图片的top坐标，超出了当前屏，则终止后续图片的遍历\n          if(elemTop > end) break;\n        }\n      }\n    };\n    \n    render();\n    \n    if(!haveScroll){\n      var timer;\n      scrollElem.on('scroll', function(){\n        var othis = $(this);\n        if(timer) clearTimeout(timer)\n        timer = setTimeout(function(){\n          render(null, othis);\n        }, 100);\n      }); \n      haveScroll = true;\n    }\n    return render;\n  };\n  \n  //暴露接口\n  exports('flow', new Flow());\n});\n"]}